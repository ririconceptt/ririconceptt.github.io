<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tu Tienda</title>

    <link rel="stylesheet" href="frontend/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>

  <body>
    <!-- MOBILE HEADER (Nude Project Style) -->
    <header class="header-mobile">
      <div class="menu-btn" id="menu-btn">
        <span></span><span></span><span></span>
      </div>

      <img src="frontend/assets/logo.png" class="logo-mobile" />

      <div class="right-icons">
        <i class="fa-regular fa-user"></i>
      </div>
    </header>

    <!-- OVERLAY -->
    <div class="menu-overlay" id="menu-overlay"></div>

    <!-- MOBILE SLIDE MENU -->
    <nav class="mobile-menu" id="mobile-menu">
      <ul>
        <li><a href="#">Inicio</a></li>
        <li><a href="#products">Productos</a></li>
        <li><a href="#">Ofertas</a></li>
        <li><a href="#">Contacto</a></li>
      </ul>
    </nav>

    <!-- DESKTOP HEADER -->
    <header class="header-desktop">
      <div class="nav-left">
        <a href="#">SALE</a>
        <a href="#">REMERAS</a>
        <a href="#">TOPS</a>
        <a href="#">PANTALONES</a>
        <a href="#">INVIERNO</a>
      </div>

      <a href="#" class="alogo">
        <img src="frontend/assets/logo.png" class="logo" />
      </a>

      <div class="nav-right">
        <a href="login.html">ADMIN</a>
      </div>
    </header>

    <!-- HERO -->
    <section class="hero">
      <div class="hero-title">NUEVO DROP DISPONIBLE</div>
      <a href="#products"> NUESTROS PRODUCTOS</a>
    </section>

    <!-- PRODUCT LIST -->
    <main>
      <section class="products" id="products"></section>
    </main>

    <!-- SUPABASE + RENDER PRODUCTS -->
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const SUPABASE_URL = "https://oioxhdxbjnoeguefahsa.supabase.co";
      const SUPABASE_KEY = "sb_publishable_B-k68Xa3Bf6vtTAmfi96Iw_MVzv6G8T";
      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      const productsEl = document.getElementById("products");

      async function loadProducts() {
        productsEl.innerHTML = "<p>Cargando productos...</p>";
        const { data: products, error } = await supabase
          .from("products")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          productsEl.innerHTML = "<p>Error cargando productos.</p>";
          return;
        }

        productsEl.innerHTML = (products || [])
          .map(
            (p) => `
          <article class="product-card">
            <div class="img-container">
              <img src="${
                p.image_url ||
                "frontend/assets/product_img/" +
                  (Math.floor(Math.random() * 6) + 1) +
                  ".jpg"
              }" alt="${p.name}">
            </div>

            <h3>${p.name}</h3>

            <p class="price">$${Number(p.price).toFixed(2)}</p>

            <button class="buy-btn" onclick="
              buyWhatsApp('${p.id}', '${encodeURIComponent(p.name)}', ${Number(
              p.price
            )})
            ">
              <i class='fa-brands fa-whatsapp'></i> Comprar
            </button>
          </article>
        `
          )
          .join("");
      }

      async function createOrder(product_id, quantity, name, contact) {
        const prod = await supabase
          .from("products")
          .select("price")
          .eq("id", product_id)
          .single();

        if (prod.error || !prod.data) {
          return { error: prod.error || { message: "Producto no encontrado" } };
        }

        const total = Number(prod.data.price || 0) * quantity;

        return await supabase.from("orders").insert([
          {
            product_id,
            quantity,
            total_price: total,
            customer_name: name || "Cliente",
            customer_contact: contact || "whatsapp",
          },
        ]);
      }

      window.buyWhatsApp = async function (productId, productName, price) {
        const name = prompt("Tu nombre (opcional)");
        const phone = prompt("WhatsApp (ej: 54911...)");

        if (!phone) return alert("Necesitás dejar un teléfono!");

        const phoneDigits = phone.replace(/\D/g, "");
        if (phoneDigits.length < 7) return alert("Número inválido");

        const { error } = await createOrder(productId, 1, name, phoneDigits);
        if (error) {
          alert("Error creando orden");
          return;
        }

        const productNameDecoded = decodeURIComponent(productName || "");
        const priceNumber = Number(price) || 0;
        const formattedPrice = priceNumber.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });

        const text = `Hola! Quisiera comprar *${productNameDecoded}* (ID: ${productId}).\nNombre: ${
          name || "-"
        }\nPrecio: $${formattedPrice}\nPor favor, escribime para coordinar.`;

        const waUrl = `https://wa.me/3878644023?text=${encodeURIComponent(
          text
        )}`;
        window.open(waUrl, "_blank");

        loadProducts();
      };

      loadProducts();
    </script>

    <!-- MOBILE MENU SCRIPT -->
    <script src="frontend/script.js"></script>
  </body>
</html>
